# File Structure & Organization

## Project Root: `G:\Crowd Detection\Crowd-Density-Estimation\`

### Core Application Files

#### Web Server & Main Entry Point
- **`main.py`** (280 lines)
  - Flask web server
  - Integrated anomaly detection pipeline
  - Video upload/download endpoints
  - Real-time stream processing
  - API endpoints for reports

#### Detection Framework
- **`algo_factory.py`** (Existing)
  - Factory pattern for clustering algorithms
  - Returns DBSCAN or KMeans based on config
  
- **`config.py`** (Existing)
  - Global configuration constants
  - Algorithm parameters (EPSILON, MIN_SAMPLES, etc.)
  - Color maps for visualization

### New Analysis Modules (Core Functionality)

#### 1. Human Detection & Tracking
- **`tracker.py`** (400 lines)
  - `TrackedPerson`: Data class for tracked individuals
  - `MultiObjectTracker`: Centroid-based tracker
  - Persistent ID assignment
  - Trajectory tracking (30-frame history)
  - Velocity calculation
  - Occlusion handling

#### 2. Pose & Movement Analysis
- **`pose_analyzer.py`** (300 lines)
  - `PoseAnalysis`: Data class for pose results
  - `PoseAnalyzer`: MediaPipe-based keypoint extraction
  - Posture classification (standing/crouching/lying)
  - Running detection
  - Gesture detection (raised arms)
  - Movement speed/direction calculation

#### 3. Crowd Behavior Modeling
- **`crowd_behavior.py`** (250 lines)
  - `CrowdFlowMetrics`: Aggregated crowd statistics
  - `CrowdBehaviorAnalyzer`: Collective behavior analyzer
  - Dominant flow direction (circular mean)
  - Flow magnitude (0-1 consistency)
  - Baseline behavior establishment
  - Real-time visualization

#### 4. Behavioral Outlier Detection
- **`outlier_detector.py`** (350 lines)
  - `AnomalyType`: Enum of 6 anomaly types
  - `BehavioralAnomaly`: Detected anomaly data
  - `BehavioralOutlierDetector`: Anomaly detection engine
  - Against-flow detection
  - Erratic movement detection
  - Stationary detection
  - Pose-based anomalies

#### 5. Appearance Anomaly Detection
- **`appearance_analyzer.py`** (400 lines)
  - `ClothingType`: Enum for clothing classification
  - `AppearanceProfile`: Visual characteristics data
  - `AppearanceAnomaly`: Detected appearance anomaly
  - `AppearanceAnalyzer`: Appearance analysis engine
  - Color analysis
  - Brightness analysis
  - Clothing classification
  - Accessory detection
  - Face covering detection
  - Statistical baseline comparison

#### 6. Event Logging & Alerts
- **`anomaly_logger.py`** (400 lines)
  - `AnomalyEvent`: Complete event data structure
  - `AnomalyLogger`: Logging and alert management
  - JSONL format persistence
  - CSV format persistence
  - Alert filtering
  - Summary statistics
  - Report generation

### Supporting Data Classes
- **`b_box.py`** (Existing)
  - `Box`: Bounding box data class
  - Used throughout detection pipeline

### Utility Modules (Existing)
- **`kmeans.py`**: KMeans clustering implementation
- **`db_scan.py`**: DBSCAN clustering implementation

### Configuration Files

#### Dependencies
- **`requirements.txt`** (Updated)
  - Flask==2.3.3
  - opencv-python==4.8.1.78
  - numpy==1.24.3
  - ultralytics==8.1.0
  - Werkzeug==2.3.7
  - scikit-learn==1.3.1
  - torch==2.1.2
  - torchvision==0.16.2
  - mediapipe==0.10.8
  - supervision==0.19.0
  - scipy==1.11.4
  - pandas==2.1.3
  - deep-sort-realtime==1.3.2

### Documentation

#### Comprehensive Guides
- **`IMPLEMENTATION_SUMMARY.md`** (This file)
  - Complete implementation overview
  - All modules and features
  - Success criteria validation
  - File organization

- **`ANOMALY_DETECTION_GUIDE.md`**
  - Technical reference guide
  - System architecture details
  - Configuration parameters
  - Thresholds and metrics
  - Performance notes
  - Troubleshooting

- **`QUICK_START.md`**
  - User-friendly setup guide
  - Running the system
  - Understanding output
  - API documentation
  - Configuration tips
  - Common issues

#### Project Documentation (Existing)
- **`README.md`**: Original project documentation
- **`.gitignore`**: Git configuration

### Web Interface

#### Templates
- **`templates/index.html`** (Existing)
  - Flask HTML template
  - Video upload form
  - Stream viewer
  - Download button

### Runtime Directories

#### Created at Runtime
- **`uploads/`**
  - User-uploaded video files
  - Temporary storage during processing

- **`outputs/`**
  - Processed video files with annotations
  - Output from video processing pipeline

- **`anomaly_logs/`**
  - Generated automatically on first detection
  - `anomaly_events.jsonl` - All events
  - `anomaly_summary.csv` - Tabular summary
  - `alerts.jsonl` - High-confidence alerts only

### Model Files

#### Downloaded on First Run
- **`yolov8m.pt`** (49.7 MB)
  - YOLOv8 medium model
  - Downloaded from Ultralytics on first use
  - Cached for subsequent runs

### Python Cache
- **`__pycache__/`**
  - Compiled Python files
  - Auto-generated by Python interpreter
  - Can be safely deleted

### Version Control
- **`.git/`**
  - Git repository data
  - Version history and branches

---

## Module Dependencies Graph

```
main.py
├── Flask (web server)
├── OpenCV (video processing)
├── YOLO (detection)
├── tracker.py
│   └── numpy
├── pose_analyzer.py
│   ├── mediapipe
│   ├── numpy
│   └── collections (deque)
├── crowd_behavior.py
│   ├── numpy
│   ├── OpenCV
│   └── collections (deque, defaultdict)
├── outlier_detector.py
│   ├── numpy
│   ├── outlier_detector.AnomalyType (enum)
│   └── collections
├── appearance_analyzer.py
│   ├── numpy
│   ├── OpenCV
│   ├── collections (defaultdict)
│   └── enum
├── anomaly_logger.py
│   ├── json
│   ├── dataclasses
│   ├── pathlib
│   ├── csv
│   ├── numpy
│   └── datetime
├── algo_factory.py
│   ├── config.py
│   ├── kmeans.py
│   └── db_scan.py
├── b_box.py
├── config.py
└── templates/index.html
```

---

## Code Organization by Feature

### Feature 1: Human Detection & Tracking
```
main.py
└── tracker.py
    ├── TrackedPerson (data class)
    └── MultiObjectTracker (engine)
        ├── .update() - Main tracking function
        ├── .distance() - Euclidean distance
        └── ._match_detections() - Hungarian-like matching
```

### Feature 2: Pose Analysis
```
main.py
└── pose_analyzer.py
    ├── PoseAnalysis (data class)
    └── PoseAnalyzer (engine)
        ├── .analyze_frame() - Main entry point
        ├── ._analyze_posture() - Classification
        ├── ._detect_running() - Running detection
        ├── ._detect_raised_arms() - Gesture detection
        └── ._calculate_gesture_confidence() - Confidence
```

### Feature 3: Crowd Behavior
```
main.py
└── crowd_behavior.py
    ├── CrowdFlowMetrics (data class)
    └── CrowdBehaviorAnalyzer (engine)
        ├── .analyze_frame() - Main analysis
        ├── ._calculate_dominant_direction() - Flow direction
        ├── ._calculate_flow_magnitude() - Flow consistency
        ├── ._set_baseline() - Baseline establishment
        ├── .get_baseline() - Baseline retrieval
        ├── .is_against_crowd_flow() - Flow checking
        └── .visualize_flow() - Visualization
```

### Feature 4: Behavioral Anomalies
```
main.py
└── outlier_detector.py
    ├── AnomalyType (enum)
    ├── BehavioralAnomaly (data class)
    └── BehavioralOutlierDetector (engine)
        ├── .detect_anomalies() - Main detection
        ├── ._analyze_person() - Per-person analysis
        ├── ._is_against_flow() - Flow check
        ├── ._detect_erratic_movement() - Erratic check
        └── .cleanup_person() - Cleanup on removal
```

### Feature 5: Appearance Anomalies
```
main.py
└── appearance_analyzer.py
    ├── ClothingType (enum)
    ├── AppearanceProfile (data class)
    ├── AppearanceAnomaly (data class)
    └── AppearanceAnalyzer (engine)
        ├── .analyze_person_appearance() - Analysis
        ├── .detect_appearance_anomalies() - Detection
        ├── ._get_dominant_color() - Color extraction
        ├── ._calculate_color_variance() - Color variance
        ├── ._calculate_brightness() - Brightness
        ├── ._classify_clothing() - Clothing type
        ├── ._detect_accessories() - Accessory detection
        ├── ._detect_face_covering() - Face covering
        ├── ._set_baseline() - Baseline establishment
        ├── ._check_person_anomaly() - Anomaly checking
        └── .cleanup_person() - Cleanup on removal
```

### Feature 6: Event Logging
```
main.py
└── anomaly_logger.py
    ├── AnomalyEvent (data class)
    └── AnomalyLogger (engine)
        ├── .log_anomalies() - Main logging
        ├── ._generate_alert() - Alert generation
        ├── ._persist_events() - File persistence
        ├── ._init_csv_headers() - CSV setup
        ├── .get_track_anomalies() - History retrieval
        ├── .get_summary_stats() - Statistics
        ├── .export_report() - Report generation
        ├── ._get_top_anomaly_tracks() - Top tracks
        └── ._generate_timeline() - Timeline generation
```

---

## File Size Estimates

| File | Lines | Size |
|------|-------|------|
| main.py | 280 | 12 KB |
| tracker.py | 400 | 16 KB |
| pose_analyzer.py | 300 | 12 KB |
| crowd_behavior.py | 250 | 10 KB |
| outlier_detector.py | 350 | 14 KB |
| appearance_analyzer.py | 400 | 16 KB |
| anomaly_logger.py | 400 | 16 KB |
| requirements.txt | 15 | 1 KB |
| DOCUMENTATION | 3 files | ~100 KB |
| **Total Code** | **~2,000** | **~96 KB** |

---

## Installation & Initialization

### First-Time Setup
```bash
1. Python 3.8+ installed
2. Virtual environment: crowd/
3. pip install -r requirements.txt
4. python main.py
5. Auto-generates:
   - yolov8m.pt (downloaded on first run)
   - uploads/ directory
   - outputs/ directory
   - anomaly_logs/ directory (on first detection)
```

### Directory Structure Created
```
G:\Crowd Detection\Crowd-Density-Estimation\
├── source code files (.py)
├── configuration files (requirements.txt)
├── documentation (.md)
├── uploads/              ← User videos
├── outputs/              ← Processed videos
├── anomaly_logs/         ← Detection logs
└── crowd/                ← Virtual environment
    └── Lib/site-packages/
```

---

## Deployment Checklist

- [x] All 6 core modules created
- [x] Main.py integration complete
- [x] Requirements.txt updated
- [x] Error handling implemented
- [x] Documentation complete
- [x] Configuration documented
- [x] API endpoints defined
- [x] Output formats specified
- [x] Testing recommendations provided
- [x] Troubleshooting guide included

---

## Next Steps for Users

1. **Read**: QUICK_START.md for immediate usage
2. **Reference**: ANOMALY_DETECTION_GUIDE.md for technical details
3. **Deploy**: Follow installation instructions
4. **Customize**: Adjust parameters in main.py
5. **Monitor**: Check anomaly_logs/ for results
6. **Analyze**: Use CSV/JSON for investigation

---

**File Organization Summary:**
- **Total Python Modules**: 6 new + 3 existing = 9
- **Total Lines of Code**: ~2,000 (new implementation)
- **Documentation Pages**: 3 comprehensive guides
- **Output Formats**: 3 (JSON, CSV, JSONL)
- **Supported Video Formats**: 3 (MP4, AVI, MOV)
- **Anomaly Types Detected**: 6 behavioral + appearance-based
- **Alert Levels**: 4 (NONE, MEDIUM, HIGH, CRITICAL)
